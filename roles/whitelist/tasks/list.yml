---

- name: Create file whitelist ownership, group and permissions
  file:
    path: /opt/zimbra/conf/whitelist
    owner: zimbra
    group: zimbra
    mode: '0644'
    state: touch


- name: Add a line to whitelist
  lineinfile:
    path: /opt/zimbra/conf/whitelist
    line: '{{ domain }}'
    create: yes


- name: Add a line to whitelist
  lineinfile:
    path:  /opt/zimbra/conf/amavisd.conf.in
    line:  read_hash(%whitelist_sender, '/opt/zimbra/conf/whitelist');
    create: yes

- name: Execute the command zmamavisdctl to restart the service
  become: true
  shell: su - zimbra -c "zmamavisdctl restart"


